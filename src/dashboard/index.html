<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Familiar Dashboard</title>
    <style>
      :root {
        --bg: #0d1117;
        --bg-card: #161b22;
        --bg-hover: #1c2129;
        --bg-input: #0d1117;
        --border: #30363d;
        --border-focus: #58a6ff;
        --text: #c9d1d9;
        --text-muted: #8b949e;
        --text-bright: #f0f6fc;
        --accent: #58a6ff;
        --green: #3fb950;
        --red: #f85149;
        --yellow: #d29922;
        --orange: #db6d28;
        --font-mono: "JetBrains Mono", "Fira Code", "SF Mono", "Cascadia Code", Consolas, monospace;
      }

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: var(--font-mono);
        background: var(--bg);
        color: var(--text);
        min-height: 100vh;
        font-size: 13px;
        line-height: 1.5;
      }

      /* Header */
      header {
        background: var(--bg-card);
        border-bottom: 1px solid var(--border);
        padding: 16px 24px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        position: sticky;
        top: 0;
        z-index: 100;
      }

      header h1 {
        font-size: 16px;
        font-weight: 600;
        color: var(--text-bright);
        letter-spacing: -0.3px;
      }

      header h1 span {
        color: var(--accent);
      }

      .header-right {
        display: flex;
        align-items: center;
        gap: 16px;
      }

      .status-indicator {
        display: flex;
        align-items: center;
        gap: 6px;
        font-size: 11px;
        color: var(--text-muted);
      }

      .status-dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: var(--green);
        animation: pulse 2s ease-in-out infinite;
      }

      .status-dot.error {
        background: var(--red);
        animation: none;
      }

      @keyframes pulse {
        0%,
        100% {
          opacity: 1;
        }
        50% {
          opacity: 0.4;
        }
      }

      /* Token input */
      .token-bar {
        background: var(--bg-card);
        border-bottom: 1px solid var(--border);
        padding: 10px 24px;
        display: flex;
        align-items: center;
        gap: 12px;
      }

      .token-bar label {
        font-size: 11px;
        color: var(--text-muted);
        text-transform: uppercase;
        letter-spacing: 0.5px;
        white-space: nowrap;
      }

      .token-bar input {
        flex: 1;
        max-width: 400px;
        background: var(--bg-input);
        border: 1px solid var(--border);
        border-radius: 4px;
        color: var(--text);
        font-family: var(--font-mono);
        font-size: 12px;
        padding: 6px 10px;
        outline: none;
      }

      .token-bar input:focus {
        border-color: var(--border-focus);
      }

      .token-bar button {
        background: var(--accent);
        color: var(--bg);
        border: none;
        border-radius: 4px;
        padding: 6px 14px;
        font-family: var(--font-mono);
        font-size: 12px;
        font-weight: 600;
        cursor: pointer;
      }

      .token-bar button:hover {
        opacity: 0.9;
      }

      /* Tab navigation */
      .tab-bar {
        background: var(--bg-card);
        border-bottom: 1px solid var(--border);
        padding: 0 24px;
        display: flex;
        gap: 0;
      }

      .tab-btn {
        background: transparent;
        border: none;
        border-bottom: 2px solid transparent;
        color: var(--text-muted);
        font-family: var(--font-mono);
        font-size: 12px;
        font-weight: 600;
        padding: 12px 20px;
        cursor: pointer;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        transition:
          color 0.15s,
          border-color 0.15s;
      }

      .tab-btn:hover {
        color: var(--text);
      }

      .tab-btn.active {
        color: var(--accent);
        border-bottom-color: var(--accent);
      }

      /* Main content */
      main {
        max-width: 1200px;
        margin: 0 auto;
        padding: 24px;
      }

      .tab-panel {
        display: none;
      }

      .tab-panel.active {
        display: block;
      }

      .section-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 16px;
      }

      .section-header h2 {
        font-size: 14px;
        font-weight: 600;
        color: var(--text-bright);
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }

      .section-header .count {
        background: var(--bg);
        border: 1px solid var(--border);
        border-radius: 10px;
        padding: 1px 8px;
        font-size: 11px;
        color: var(--text-muted);
        margin-left: 8px;
      }

      .section-header-actions {
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .refresh-btn {
        background: transparent;
        border: 1px solid var(--border);
        border-radius: 4px;
        color: var(--text-muted);
        font-family: var(--font-mono);
        font-size: 11px;
        padding: 4px 10px;
        cursor: pointer;
      }

      .refresh-btn:hover {
        color: var(--text);
        border-color: var(--text-muted);
      }

      .create-btn {
        background: var(--green);
        color: var(--bg);
        border: none;
        border-radius: 4px;
        font-family: var(--font-mono);
        font-size: 11px;
        font-weight: 600;
        padding: 5px 12px;
        cursor: pointer;
      }

      .create-btn:hover {
        opacity: 0.9;
      }

      /* Jobs table */
      .jobs-table {
        width: 100%;
        border-collapse: collapse;
        border: 1px solid var(--border);
        border-radius: 6px;
        overflow: hidden;
      }

      .jobs-table thead th {
        background: var(--bg-card);
        padding: 10px 14px;
        text-align: left;
        font-size: 11px;
        font-weight: 600;
        color: var(--text-muted);
        text-transform: uppercase;
        letter-spacing: 0.5px;
        border-bottom: 1px solid var(--border);
      }

      .jobs-table tbody tr {
        cursor: pointer;
        transition: background 0.15s;
      }

      .jobs-table tbody tr:hover {
        background: var(--bg-hover);
      }

      .jobs-table tbody tr.selected {
        background: var(--bg-hover);
        outline: 1px solid var(--border-focus);
        outline-offset: -1px;
      }

      .jobs-table td {
        padding: 10px 14px;
        border-bottom: 1px solid var(--border);
        vertical-align: middle;
      }

      .jobs-table tbody tr:last-child td {
        border-bottom: none;
      }

      .job-id {
        color: var(--accent);
        font-weight: 600;
      }

      .job-label {
        color: var(--text-muted);
        font-size: 11px;
        margin-top: 2px;
      }

      .badge {
        display: inline-block;
        padding: 2px 8px;
        border-radius: 10px;
        font-size: 10px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.3px;
      }

      .badge-ok {
        background: rgba(63, 185, 80, 0.15);
        color: var(--green);
      }

      .badge-error {
        background: rgba(248, 81, 73, 0.15);
        color: var(--red);
      }

      .badge-disabled {
        background: rgba(139, 148, 158, 0.15);
        color: var(--text-muted);
      }

      .badge-never {
        background: rgba(139, 148, 158, 0.1);
        color: var(--text-muted);
      }

      .badge-running {
        background: rgba(210, 153, 34, 0.15);
        color: var(--yellow);
      }

      .badge-active {
        background: rgba(63, 185, 80, 0.15);
        color: var(--green);
      }

      .badge-idle {
        background: rgba(88, 166, 255, 0.15);
        color: var(--accent);
      }

      .run-now-btn {
        background: transparent;
        border: 1px solid var(--border);
        border-radius: 4px;
        color: var(--text-muted);
        font-family: var(--font-mono);
        font-size: 11px;
        padding: 3px 10px;
        cursor: pointer;
        white-space: nowrap;
      }

      .run-now-btn:hover {
        color: var(--accent);
        border-color: var(--accent);
      }

      .run-now-btn:disabled {
        opacity: 0.4;
        cursor: not-allowed;
      }

      .run-now-btn.running {
        color: var(--yellow);
        border-color: var(--yellow);
        cursor: wait;
      }

      .action-btn {
        background: transparent;
        border: 1px solid var(--border);
        border-radius: 4px;
        color: var(--text-muted);
        font-family: var(--font-mono);
        font-size: 11px;
        padding: 3px 8px;
        cursor: pointer;
        white-space: nowrap;
      }

      .action-btn:hover {
        color: var(--text);
        border-color: var(--text-muted);
      }

      .action-btn.delete:hover {
        color: var(--red);
        border-color: var(--red);
      }

      .action-group {
        display: flex;
        gap: 4px;
        align-items: center;
      }

      /* Run history panel */
      .run-history {
        margin-top: 24px;
        border: 1px solid var(--border);
        border-radius: 6px;
        overflow: hidden;
        display: none;
      }

      .run-history.visible {
        display: block;
      }

      .run-history-header {
        background: var(--bg-card);
        padding: 12px 14px;
        border-bottom: 1px solid var(--border);
        display: flex;
        align-items: center;
        justify-content: space-between;
      }

      .run-history-header h3 {
        font-size: 13px;
        font-weight: 600;
        color: var(--text-bright);
      }

      .close-btn {
        background: transparent;
        border: none;
        color: var(--text-muted);
        font-size: 18px;
        cursor: pointer;
        padding: 0 4px;
        line-height: 1;
      }

      .close-btn:hover {
        color: var(--text);
      }

      .runs-table {
        width: 100%;
        border-collapse: collapse;
      }

      .runs-table thead th {
        background: var(--bg-card);
        padding: 8px 14px;
        text-align: left;
        font-size: 10px;
        font-weight: 600;
        color: var(--text-muted);
        text-transform: uppercase;
        letter-spacing: 0.5px;
        border-bottom: 1px solid var(--border);
      }

      .runs-table td {
        padding: 8px 14px;
        border-bottom: 1px solid var(--border);
        font-size: 12px;
      }

      .runs-table tbody tr:last-child td {
        border-bottom: none;
      }

      .result-preview {
        max-width: 400px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
        color: var(--text-muted);
        font-size: 11px;
      }

      /* Agents table */
      .agents-table {
        width: 100%;
        border-collapse: collapse;
        border: 1px solid var(--border);
        border-radius: 6px;
        overflow: hidden;
      }

      .agents-table thead th {
        background: var(--bg-card);
        padding: 10px 14px;
        text-align: left;
        font-size: 11px;
        font-weight: 600;
        color: var(--text-muted);
        text-transform: uppercase;
        letter-spacing: 0.5px;
        border-bottom: 1px solid var(--border);
      }

      .agents-table td {
        padding: 10px 14px;
        border-bottom: 1px solid var(--border);
        vertical-align: middle;
      }

      .agents-table tbody tr:last-child td {
        border-bottom: none;
      }

      /* Pipeline health cards */
      .pipeline-cards {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
        gap: 16px;
      }

      .pipeline-card {
        background: var(--bg-card);
        border: 1px solid var(--border);
        border-radius: 6px;
        padding: 16px;
      }

      .pipeline-card-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 12px;
      }

      .pipeline-card-title {
        font-size: 14px;
        font-weight: 600;
        color: var(--text-bright);
      }

      .pipeline-stat-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 8px;
        margin-bottom: 12px;
      }

      .pipeline-stat {
        background: var(--bg);
        border-radius: 4px;
        padding: 8px 10px;
      }

      .pipeline-stat-label {
        font-size: 10px;
        color: var(--text-muted);
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 2px;
      }

      .pipeline-stat-value {
        font-size: 16px;
        font-weight: 600;
        color: var(--text-bright);
      }

      .pipeline-blockers {
        margin-top: 8px;
      }

      .pipeline-blockers-label {
        font-size: 10px;
        color: var(--text-muted);
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 4px;
      }

      .pipeline-blocker-item {
        font-size: 11px;
        color: var(--orange);
        padding: 2px 0;
      }

      /* Modal */
      .modal-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.6);
        z-index: 300;
        align-items: center;
        justify-content: center;
      }

      .modal-overlay.visible {
        display: flex;
      }

      .modal {
        background: var(--bg-card);
        border: 1px solid var(--border);
        border-radius: 8px;
        width: 90%;
        max-width: 560px;
        max-height: 90vh;
        overflow-y: auto;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
      }

      .modal-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 16px 20px;
        border-bottom: 1px solid var(--border);
      }

      .modal-header h3 {
        font-size: 14px;
        font-weight: 600;
        color: var(--text-bright);
      }

      .modal-body {
        padding: 20px;
      }

      .form-group {
        margin-bottom: 14px;
      }

      .form-group label {
        display: block;
        font-size: 11px;
        color: var(--text-muted);
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 4px;
      }

      .form-group input,
      .form-group select,
      .form-group textarea {
        width: 100%;
        background: var(--bg-input);
        border: 1px solid var(--border);
        border-radius: 4px;
        color: var(--text);
        font-family: var(--font-mono);
        font-size: 12px;
        padding: 8px 10px;
        outline: none;
      }

      .form-group input:focus,
      .form-group select:focus,
      .form-group textarea:focus {
        border-color: var(--border-focus);
      }

      .form-group textarea {
        min-height: 80px;
        resize: vertical;
      }

      .form-group select {
        appearance: none;
        -webkit-appearance: none;
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' fill='%238b949e' viewBox='0 0 16 16'%3E%3Cpath d='M4.427 7.427l3.396 3.396a.25.25 0 00.354 0l3.396-3.396A.25.25 0 0011.396 7H4.604a.25.25 0 00-.177.427z'/%3E%3C/svg%3E");
        background-repeat: no-repeat;
        background-position: right 10px center;
        padding-right: 30px;
      }

      .form-row {
        display: flex;
        gap: 12px;
      }

      .form-row .form-group {
        flex: 1;
      }

      .form-group-checkbox {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-bottom: 14px;
      }

      .form-group-checkbox input[type="checkbox"] {
        width: 16px;
        height: 16px;
        accent-color: var(--accent);
        cursor: pointer;
      }

      .form-group-checkbox label {
        font-size: 12px;
        color: var(--text);
        cursor: pointer;
        text-transform: none;
        letter-spacing: 0;
      }

      .modal-footer {
        display: flex;
        align-items: center;
        justify-content: flex-end;
        gap: 8px;
        padding: 16px 20px;
        border-top: 1px solid var(--border);
      }

      .btn-cancel {
        background: transparent;
        border: 1px solid var(--border);
        border-radius: 4px;
        color: var(--text-muted);
        font-family: var(--font-mono);
        font-size: 12px;
        padding: 6px 16px;
        cursor: pointer;
      }

      .btn-cancel:hover {
        color: var(--text);
        border-color: var(--text-muted);
      }

      .btn-save {
        background: var(--accent);
        color: var(--bg);
        border: none;
        border-radius: 4px;
        font-family: var(--font-mono);
        font-size: 12px;
        font-weight: 600;
        padding: 7px 18px;
        cursor: pointer;
      }

      .btn-save:hover {
        opacity: 0.9;
      }

      .btn-save:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }

      .btn-danger {
        background: var(--red);
        color: var(--bg);
        border: none;
        border-radius: 4px;
        font-family: var(--font-mono);
        font-size: 12px;
        font-weight: 600;
        padding: 7px 18px;
        cursor: pointer;
      }

      .btn-danger:hover {
        opacity: 0.9;
      }

      /* Confirm dialog */
      .confirm-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.6);
        z-index: 400;
        align-items: center;
        justify-content: center;
      }

      .confirm-overlay.visible {
        display: flex;
      }

      .confirm-dialog {
        background: var(--bg-card);
        border: 1px solid var(--border);
        border-radius: 8px;
        padding: 24px;
        max-width: 400px;
        width: 90%;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
      }

      .confirm-dialog p {
        margin-bottom: 20px;
        font-size: 13px;
        color: var(--text);
        line-height: 1.6;
      }

      .confirm-dialog .confirm-actions {
        display: flex;
        justify-content: flex-end;
        gap: 8px;
      }

      /* Empty & loading states */
      .empty-state {
        text-align: center;
        padding: 48px 24px;
        color: var(--text-muted);
      }

      .empty-state .icon {
        font-size: 32px;
        margin-bottom: 12px;
        opacity: 0.4;
      }

      .loading {
        text-align: center;
        padding: 24px;
        color: var(--text-muted);
      }

      .loading::after {
        content: "";
        display: inline-block;
        width: 12px;
        height: 12px;
        border: 2px solid var(--border);
        border-top-color: var(--accent);
        border-radius: 50%;
        animation: spin 0.8s linear infinite;
        margin-left: 8px;
        vertical-align: middle;
      }

      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }

      /* Toast notifications */
      .toast-container {
        position: fixed;
        bottom: 24px;
        right: 24px;
        z-index: 200;
        display: flex;
        flex-direction: column;
        gap: 8px;
      }

      .toast {
        background: var(--bg-card);
        border: 1px solid var(--border);
        border-radius: 6px;
        padding: 10px 16px;
        font-size: 12px;
        color: var(--text);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
        animation: slideIn 0.2s ease-out;
        max-width: 360px;
      }

      .toast.success {
        border-color: var(--green);
      }

      .toast.error {
        border-color: var(--red);
      }

      @keyframes slideIn {
        from {
          transform: translateX(20px);
          opacity: 0;
        }
        to {
          transform: translateX(0);
          opacity: 1;
        }
      }

      /* Responsive */
      @media (max-width: 768px) {
        main {
          padding: 16px;
        }
        .jobs-table td,
        .jobs-table th {
          padding: 8px 10px;
        }
        .agents-table td,
        .agents-table th {
          padding: 8px 10px;
        }
        .hide-mobile {
          display: none;
        }
        .tab-btn {
          padding: 10px 12px;
          font-size: 11px;
        }
        .pipeline-cards {
          grid-template-columns: 1fr;
        }
      }
    </style>
  </head>
  <body>
    <header>
      <h1><span>&gt;</span> Familiar Dashboard</h1>
      <div class="header-right">
        <div class="status-indicator">
          <div class="status-dot" id="statusDot"></div>
          <span id="statusText">connecting...</span>
        </div>
      </div>
    </header>

    <div class="token-bar" id="tokenBar">
      <label for="tokenInput">API Token</label>
      <input
        type="password"
        id="tokenInput"
        placeholder="paste your familiar webhook token"
        autocomplete="off"
      />
      <button onclick="saveToken()">Connect</button>
    </div>

    <div class="tab-bar">
      <button class="tab-btn active" data-tab="cron" onclick="switchTab('cron')">Cron Jobs</button>
      <button class="tab-btn" data-tab="tasks" onclick="switchTab('tasks')">Tasks</button>
      <button class="tab-btn" data-tab="agents" onclick="switchTab('agents')">Agents</button>
      <button class="tab-btn" data-tab="pipeline" onclick="switchTab('pipeline')">
        Pipeline Health
      </button>
    </div>

    <main>
      <!-- Cron Jobs Tab -->
      <div class="tab-panel active" id="tab-cron">
        <div class="section-header">
          <h2>Cron Jobs <span class="count" id="jobCount">0</span></h2>
          <div class="section-header-actions">
            <button class="create-btn" onclick="openCreateJobModal()">+ Create Job</button>
            <button class="refresh-btn" onclick="loadJobs()">Refresh</button>
          </div>
        </div>

        <div id="jobsContainer">
          <div class="empty-state" id="emptyState">
            <div class="icon">&gt;_</div>
            <div>Enter your API token above to connect</div>
          </div>
        </div>

        <div class="run-history" id="runHistory">
          <div class="run-history-header">
            <h3 id="runHistoryTitle">Run History</h3>
            <button class="close-btn" onclick="closeHistory()">&times;</button>
          </div>
          <div id="runsContainer"></div>
        </div>
      </div>

      <!-- Tasks Tab -->
      <div class="tab-panel" id="tab-tasks">
        <div class="section-header">
          <h2>Tasks <span class="count" id="taskCount">0</span></h2>
          <div class="section-header-actions">
            <select
              id="taskStatusFilter"
              onchange="renderTasks()"
              style="
                background: var(--bg-input);
                border: 1px solid var(--border);
                border-radius: 4px;
                color: var(--text);
                font-family: var(--font-mono);
                font-size: 11px;
                padding: 4px 8px;
                outline: none;
              "
            >
              <option value="">All</option>
              <option value="ready">Ready</option>
              <option value="in_progress">In Progress</option>
              <option value="completed">Completed</option>
              <option value="failed">Failed</option>
            </select>
            <button class="create-btn" onclick="openCreateTaskModal()">+ Create Task</button>
            <button class="refresh-btn" onclick="loadTasks()">Refresh</button>
          </div>
        </div>

        <div id="tasksContainer">
          <div class="empty-state">
            <div class="icon">&gt;_</div>
            <div>Loading tasks...</div>
          </div>
        </div>
      </div>

      <!-- Agents Tab -->
      <div class="tab-panel" id="tab-agents">
        <div class="section-header">
          <h2>Active Agents <span class="count" id="agentCount">0</span></h2>
          <div class="section-header-actions">
            <button class="refresh-btn" onclick="loadAgents()">Refresh</button>
          </div>
        </div>

        <div id="agentsContainer">
          <div class="empty-state">
            <div class="icon">&gt;_</div>
            <div>Loading agents...</div>
          </div>
        </div>
      </div>

      <!-- Pipeline Health Tab -->
      <div class="tab-panel" id="tab-pipeline">
        <div class="section-header">
          <h2>Pipeline Health</h2>
          <div class="section-header-actions">
            <button class="refresh-btn" onclick="loadPipelineHealth()">Refresh</button>
          </div>
        </div>

        <div id="pipelineContainer">
          <div class="empty-state">
            <div class="icon">&gt;_</div>
            <div>Loading pipeline health...</div>
          </div>
        </div>
      </div>
    </main>

    <div class="toast-container" id="toastContainer"></div>

    <!-- Job Create/Edit Modal -->
    <div class="modal-overlay" id="jobModal">
      <div class="modal">
        <div class="modal-header">
          <h3 id="jobModalTitle">Create Job</h3>
          <button class="close-btn" onclick="closeJobModal()">&times;</button>
        </div>
        <div class="modal-body">
          <input type="hidden" id="jobModalMode" value="create" />
          <div class="form-group">
            <label for="jobFormId">ID</label>
            <input type="text" id="jobFormId" placeholder="my-cron-job" />
          </div>
          <div class="form-group">
            <label for="jobFormLabel">Label</label>
            <input type="text" id="jobFormLabel" placeholder="Human-readable description" />
          </div>
          <div class="form-row">
            <div class="form-group">
              <label for="jobFormSchedule">Schedule (cron)</label>
              <input type="text" id="jobFormSchedule" placeholder="*/30 * * * *" />
            </div>
            <div class="form-group">
              <label for="jobFormTimezone">Timezone</label>
              <input
                type="text"
                id="jobFormTimezone"
                placeholder="America/Chicago"
                value="America/Chicago"
              />
            </div>
          </div>
          <div class="form-group">
            <label for="jobFormPrompt">Prompt</label>
            <textarea id="jobFormPrompt" placeholder="What should the agent do?"></textarea>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label for="jobFormModel">Model</label>
              <select id="jobFormModel">
                <option value="sonnet">sonnet</option>
                <option value="opus">opus</option>
                <option value="haiku">haiku</option>
              </select>
            </div>
            <div class="form-group">
              <label for="jobFormMaxTurns">Max Turns</label>
              <input type="number" id="jobFormMaxTurns" placeholder="25" value="25" min="1" />
            </div>
          </div>
          <div class="form-group">
            <label for="jobFormWorkDir">Working Directory</label>
            <input type="text" id="jobFormWorkDir" placeholder="/home/mwhit/clawd" />
          </div>
          <div class="form-group-checkbox">
            <input type="checkbox" id="jobFormAnnounce" />
            <label for="jobFormAnnounce">Announce results to chat</label>
          </div>
          <div class="form-group-checkbox">
            <input type="checkbox" id="jobFormEnabled" checked />
            <label for="jobFormEnabled">Enabled</label>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn-cancel" onclick="closeJobModal()">Cancel</button>
          <button class="btn-save" id="jobModalSave" onclick="saveJob()">Create</button>
        </div>
      </div>
    </div>

    <!-- Task Modal -->
    <div class="modal-overlay" id="taskModal">
      <div class="modal">
        <div class="modal-header">
          <h3 id="taskModalTitle">Create Task</h3>
          <button class="close-btn" onclick="closeTaskModal()">&times;</button>
        </div>
        <div class="modal-body">
          <input type="hidden" id="taskModalMode" value="create" />
          <input type="hidden" id="taskFormId" value="" />
          <div class="form-group">
            <label>Title *</label>
            <input type="text" id="taskFormTitle" placeholder="Task title" />
          </div>
          <div class="form-group">
            <label>Description</label>
            <textarea id="taskFormDescription" rows="3" placeholder="Task description"></textarea>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label>Assigned Agent</label>
              <select id="taskFormAgent">
                <option value="">Unassigned</option>
              </select>
            </div>
            <div class="form-group">
              <label>Priority (1=highest)</label>
              <input type="number" id="taskFormPriority" value="5" min="1" max="10" />
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label>Status</label>
              <select id="taskFormStatus">
                <option value="ready">Ready</option>
                <option value="in_progress">In Progress</option>
                <option value="completed">Completed</option>
                <option value="failed">Failed</option>
              </select>
            </div>
            <div class="form-group">
              <label style="display: flex; align-items: center; gap: 8px">
                <input type="checkbox" id="taskFormRecurring" /> Recurring
              </label>
            </div>
          </div>
          <div class="form-group">
            <label>Recurrence Schedule (cron)</label>
            <input type="text" id="taskFormRecurrenceSchedule" placeholder="0 * * * * (optional)" />
          </div>
          <div class="form-group">
            <label>Tags (comma-separated)</label>
            <input type="text" id="taskFormTags" placeholder="engineering, pipeline" />
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn-cancel" onclick="closeTaskModal()">Cancel</button>
          <button class="btn-save" id="taskModalSave" onclick="saveTask()">Create</button>
        </div>
      </div>
    </div>

    <!-- Confirm Delete Dialog -->
    <div class="confirm-overlay" id="confirmDialog">
      <div class="confirm-dialog">
        <p id="confirmMessage">Are you sure?</p>
        <div class="confirm-actions">
          <button class="btn-cancel" onclick="closeConfirm()">Cancel</button>
          <button class="btn-danger" id="confirmAction" onclick="confirmCallback()">Delete</button>
        </div>
      </div>
    </div>

    <script>
      // -- State --
      let token = localStorage.getItem("familiar_token") || "";
      let jobs = [];
      let agents = [];
      let selectedJobId = null;
      let refreshTimer = null;
      let runningJobs = new Set();
      let activeTab = "cron";
      let pendingConfirmCallback = null;

      // -- Init --
      document.addEventListener("DOMContentLoaded", () => {
        const input = document.getElementById("tokenInput");
        input.value = token;
        input.addEventListener("keydown", (e) => {
          if (e.key === "Enter") saveToken();
        });
        if (token) {
          loadJobs();
          startAutoRefresh();
        }
      });

      // -- Token --
      function saveToken() {
        token = document.getElementById("tokenInput").value.trim();
        if (!token) return;
        localStorage.setItem("familiar_token", token);
        loadJobs();
        startAutoRefresh();
      }

      // -- Tab Navigation --
      function switchTab(tab) {
        activeTab = tab;
        document.querySelectorAll(".tab-btn").forEach((btn) => {
          btn.classList.toggle("active", btn.dataset.tab === tab);
        });
        document.querySelectorAll(".tab-panel").forEach((panel) => {
          panel.classList.toggle("active", panel.id === "tab-" + tab);
        });

        if (tab === "tasks") loadTasks();
        if (tab === "agents") loadAgents();
        if (tab === "pipeline") loadPipelineHealth();
      }

      // -- API helpers --
      function apiBase() {
        return window.location.origin;
      }

      async function apiFetch(path, opts = {}) {
        const res = await fetch(apiBase() + path, {
          ...opts,
          headers: {
            "Content-Type": "application/json",
            "x-familiar-token": token,
            ...(opts.headers || {}),
          },
        });
        const data = await res.json();
        if (!res.ok) throw new Error(data.error || `HTTP ${res.status}`);
        return data;
      }

      // -- Load Jobs --
      async function loadJobs() {
        if (!token) return;

        try {
          const data = await apiFetch("/api/cron/jobs");
          jobs = data.jobs || [];
          renderJobs();
          setStatus("connected", true);
        } catch (e) {
          setStatus(e.message, false);
          if (e.message.includes("Unauthorized")) {
            toast("Invalid token", "error");
          }
        }
      }

      // -- Render Jobs --
      function renderJobs() {
        const container = document.getElementById("jobsContainer");
        document.getElementById("jobCount").textContent = jobs.length;

        if (jobs.length === 0) {
          container.innerHTML = `
          <div class="empty-state">
            <div class="icon">&gt;_</div>
            <div>No cron jobs configured</div>
          </div>
        `;
          return;
        }

        let html = `
        <table class="jobs-table">
          <thead>
            <tr>
              <th>Job</th>
              <th>Schedule</th>
              <th>Status</th>
              <th>Last Run</th>
              <th class="hide-mobile">Next Run</th>
              <th class="hide-mobile">Runs</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
      `;

        for (const job of jobs) {
          const isSelected = selectedJobId === job.id;
          const isRunning = runningJobs.has(job.id);

          html += `
          <tr class="${isSelected ? "selected" : ""}" onclick="selectJob('${esc(job.id)}')">
            <td>
              <div class="job-id">${esc(job.id)}</div>
              ${job.label ? `<div class="job-label">${esc(job.label)}</div>` : ""}
            </td>
            <td>${esc(job.schedule)}</td>
            <td>${statusBadge(job)}</td>
            <td>${formatRelative(job.lastRun)}</td>
            <td class="hide-mobile">${formatRelative(job.nextRun)}</td>
            <td class="hide-mobile">${job.runCount}</td>
            <td>
              <div class="action-group">
                <button class="run-now-btn ${isRunning ? "running" : ""}"
                        onclick="event.stopPropagation(); triggerJob('${esc(job.id)}')"
                        ${isRunning || job.enabled === false ? "disabled" : ""}>
                  ${isRunning ? "Running..." : "Run"}
                </button>
                <button class="action-btn"
                        onclick="event.stopPropagation(); openEditJobModal('${esc(job.id)}')"
                        title="Edit">Edit</button>
                <button class="action-btn delete"
                        onclick="event.stopPropagation(); confirmDeleteJob('${esc(job.id)}')"
                        title="Delete">Del</button>
              </div>
            </td>
          </tr>
        `;
        }

        html += "</tbody></table>";
        container.innerHTML = html;
      }

      function statusBadge(job) {
        if (job.enabled === false) return '<span class="badge badge-disabled">disabled</span>';
        if (runningJobs.has(job.id)) return '<span class="badge badge-running">running</span>';
        if (!job.lastRun) return '<span class="badge badge-never">never run</span>';
        return '<span class="badge badge-ok">ok</span>';
      }

      // -- Select Job / Run History --
      async function selectJob(jobId) {
        if (selectedJobId === jobId) {
          closeHistory();
          return;
        }

        selectedJobId = jobId;
        renderJobs();

        const panel = document.getElementById("runHistory");
        const titleEl = document.getElementById("runHistoryTitle");
        const container = document.getElementById("runsContainer");

        titleEl.textContent = `Run History: ${jobId}`;
        container.innerHTML = '<div class="loading">Loading runs</div>';
        panel.classList.add("visible");

        try {
          const data = await apiFetch(`/api/cron/jobs/${encodeURIComponent(jobId)}/runs`);
          renderRuns(data.runs || []);
        } catch (e) {
          container.innerHTML = `<div class="empty-state"><div>Failed to load: ${esc(e.message)}</div></div>`;
        }
      }

      function renderRuns(runs) {
        const container = document.getElementById("runsContainer");

        if (runs.length === 0) {
          container.innerHTML = '<div class="empty-state"><div>No runs recorded yet</div></div>';
          return;
        }

        let html = `
        <table class="runs-table">
          <thead>
            <tr>
              <th>Started</th>
              <th>Duration</th>
              <th>Cost</th>
              <th>Turns</th>
              <th>Status</th>
              <th>Result</th>
            </tr>
          </thead>
          <tbody>
      `;

        for (const run of runs) {
          html += `
          <tr>
            <td>${formatTimestamp(run.startedAt)}</td>
            <td>${formatDuration(run.durationMs)}</td>
            <td>${run.costUsd != null ? "$" + run.costUsd.toFixed(4) : "-"}</td>
            <td>${run.numTurns ?? "-"}</td>
            <td>${run.isError ? '<span class="badge badge-error">error</span>' : '<span class="badge badge-ok">ok</span>'}</td>
            <td><div class="result-preview" title="${esc(run.resultPreview || "")}">${esc(run.resultPreview || "-")}</div></td>
          </tr>
        `;
        }

        html += "</tbody></table>";
        container.innerHTML = html;
      }

      function closeHistory() {
        selectedJobId = null;
        document.getElementById("runHistory").classList.remove("visible");
        renderJobs();
      }

      // -- Job CRUD Modal --
      function openCreateJobModal() {
        document.getElementById("jobModalMode").value = "create";
        document.getElementById("jobModalTitle").textContent = "Create Job";
        document.getElementById("jobModalSave").textContent = "Create";
        document.getElementById("jobFormId").value = "";
        document.getElementById("jobFormId").disabled = false;
        document.getElementById("jobFormLabel").value = "";
        document.getElementById("jobFormSchedule").value = "";
        document.getElementById("jobFormTimezone").value = "America/Chicago";
        document.getElementById("jobFormPrompt").value = "";
        document.getElementById("jobFormModel").value = "sonnet";
        document.getElementById("jobFormMaxTurns").value = "25";
        document.getElementById("jobFormWorkDir").value = "";
        document.getElementById("jobFormAnnounce").checked = false;
        document.getElementById("jobFormEnabled").checked = true;
        document.getElementById("jobModal").classList.add("visible");
      }

      function openEditJobModal(jobId) {
        const job = jobs.find((j) => j.id === jobId);
        if (!job) return;

        document.getElementById("jobModalMode").value = "edit";
        document.getElementById("jobModalTitle").textContent = `Edit: ${job.id}`;
        document.getElementById("jobModalSave").textContent = "Save";
        document.getElementById("jobFormId").value = job.id;
        document.getElementById("jobFormId").disabled = true;
        document.getElementById("jobFormLabel").value = job.label || "";
        document.getElementById("jobFormSchedule").value = job.schedule || "";
        document.getElementById("jobFormTimezone").value = job.timezone || "America/Chicago";
        document.getElementById("jobFormPrompt").value = job.prompt || "";
        document.getElementById("jobFormModel").value = job.model || "sonnet";
        document.getElementById("jobFormMaxTurns").value = job.maxTurns ?? 25;
        document.getElementById("jobFormWorkDir").value = job.workingDirectory || "";
        document.getElementById("jobFormAnnounce").checked = !!job.announce;
        document.getElementById("jobFormEnabled").checked = job.enabled !== false;
        document.getElementById("jobModal").classList.add("visible");
      }

      function closeJobModal() {
        document.getElementById("jobModal").classList.remove("visible");
      }

      async function saveJob() {
        const mode = document.getElementById("jobModalMode").value;
        const id = document.getElementById("jobFormId").value.trim();
        if (!id) {
          toast("Job ID is required", "error");
          return;
        }

        const schedule = document.getElementById("jobFormSchedule").value.trim();
        if (!schedule) {
          toast("Schedule is required", "error");
          return;
        }

        const payload = {
          id: id,
          label: document.getElementById("jobFormLabel").value.trim() || undefined,
          schedule: schedule,
          timezone: document.getElementById("jobFormTimezone").value.trim() || undefined,
          prompt: document.getElementById("jobFormPrompt").value.trim() || undefined,
          model: document.getElementById("jobFormModel").value,
          maxTurns: parseInt(document.getElementById("jobFormMaxTurns").value) || 25,
          workingDirectory: document.getElementById("jobFormWorkDir").value.trim() || undefined,
          announce: document.getElementById("jobFormAnnounce").checked,
          enabled: document.getElementById("jobFormEnabled").checked,
        };

        const saveBtn = document.getElementById("jobModalSave");
        saveBtn.disabled = true;
        saveBtn.textContent = "Saving...";

        try {
          if (mode === "create") {
            await apiFetch("/api/cron/jobs", {
              method: "POST",
              body: JSON.stringify(payload),
            });
            toast(`Job "${id}" created`, "success");
          } else {
            await apiFetch(`/api/cron/jobs/${encodeURIComponent(id)}`, {
              method: "PUT",
              body: JSON.stringify(payload),
            });
            toast(`Job "${id}" updated`, "success");
          }
          closeJobModal();
          await loadJobs();
        } catch (e) {
          toast(`Failed to save: ${e.message}`, "error");
        } finally {
          saveBtn.disabled = false;
          saveBtn.textContent = mode === "create" ? "Create" : "Save";
        }
      }

      // -- Delete Job --
      function confirmDeleteJob(jobId) {
        document.getElementById("confirmMessage").textContent =
          `Delete job "${jobId}"? This cannot be undone.`;
        pendingConfirmCallback = async () => {
          closeConfirm();
          try {
            await apiFetch(`/api/cron/jobs/${encodeURIComponent(jobId)}`, {
              method: "DELETE",
            });
            toast(`Job "${jobId}" deleted`, "success");
            if (selectedJobId === jobId) closeHistory();
            await loadJobs();
          } catch (e) {
            toast(`Failed to delete: ${e.message}`, "error");
          }
        };
        document.getElementById("confirmDialog").classList.add("visible");
      }

      function confirmCallback() {
        if (pendingConfirmCallback) pendingConfirmCallback();
      }

      function closeConfirm() {
        document.getElementById("confirmDialog").classList.remove("visible");
        pendingConfirmCallback = null;
      }

      // -- Trigger Job --
      async function triggerJob(jobId) {
        if (runningJobs.has(jobId)) return;

        runningJobs.add(jobId);
        renderJobs();
        toast(`Triggering ${jobId}...`, "info");

        try {
          const result = await apiFetch(`/api/cron/jobs/${encodeURIComponent(jobId)}/run`, {
            method: "POST",
          });

          runningJobs.delete(jobId);

          if (result.status === "error") {
            toast(
              `${jobId} completed with error: ${result.text?.slice(0, 100) || "unknown"}`,
              "error",
            );
          } else {
            const cost = result.costUsd != null ? ` ($${result.costUsd.toFixed(4)})` : "";
            const dur = result.durationMs != null ? ` in ${formatDuration(result.durationMs)}` : "";
            toast(`${jobId} completed${dur}${cost}`, "success");
          }

          await loadJobs();
          if (selectedJobId === jobId) {
            selectJob(jobId);
          }
        } catch (e) {
          runningJobs.delete(jobId);
          toast(`Failed to trigger ${jobId}: ${e.message}`, "error");
          renderJobs();
        }
      }

      // -- Agents --
      async function loadAgents() {
        if (!token) return;
        const container = document.getElementById("agentsContainer");
        container.innerHTML = '<div class="loading">Loading agents</div>';

        try {
          // Load cron agents (the actual configured agents) + sub-agents
          const [cronData, subData] = await Promise.all([
            apiFetch("/api/cron/jobs"),
            apiFetch("/api/agents").catch(() => ({ active: [], recent: [] })),
          ]);
          const cronAgents = cronData.jobs || [];
          const subAgents = [...(subData.active || []), ...(subData.recent || [])];
          renderAgents(cronAgents, subAgents);
        } catch (e) {
          container.innerHTML = `<div class="empty-state"><div>Failed to load agents: ${esc(e.message)}</div></div>`;
        }
      }

      function renderAgents(cronAgents, subAgents) {
        const container = document.getElementById("agentsContainer");
        document.getElementById("agentCount").textContent = cronAgents.length;

        if (cronAgents.length === 0) {
          container.innerHTML = `
          <div class="empty-state">
            <div class="icon">&gt;_</div>
            <div>No agents configured</div>
          </div>`;
          return;
        }

        let html = `
        <table class="agents-table">
          <thead>
            <tr>
              <th>Agent</th>
              <th>Model</th>
              <th>Schedule</th>
              <th>Status</th>
              <th class="hide-mobile">Last Run</th>
              <th class="hide-mobile">Runs</th>
            </tr>
          </thead>
          <tbody>
      `;

        for (const agent of cronAgents) {
          const isRunning = runningJobs.has(agent.id);
          const statusHtml =
            agent.enabled === false
              ? '<span class="badge badge-disabled">disabled</span>'
              : isRunning
                ? '<span class="badge badge-running">running</span>'
                : !agent.lastRun
                  ? '<span class="badge badge-never">never run</span>'
                  : '<span class="badge badge-ok">ok</span>';

          html += `
          <tr>
            <td>
              <span class="job-id">${esc(agent.id)}</span>
              ${agent.label ? `<div class="job-label">${esc(agent.label)}</div>` : ""}
            </td>
            <td><span class="badge badge-idle">${esc(agent.model || "sonnet")}</span></td>
            <td>${esc(agent.schedule)}</td>
            <td>${statusHtml}</td>
            <td class="hide-mobile">${formatRelative(agent.lastRun)}</td>
            <td class="hide-mobile">${agent.runCount ?? 0}</td>
          </tr>
        `;
        }

        html += "</tbody></table>";

        // Show active sub-agents if any
        if (subAgents.length > 0) {
          html += `<h3 style="margin-top:24px;font-size:13px;color:var(--text-bright);margin-bottom:8px">Active Sub-Agents <span class="count">${subAgents.length}</span></h3>`;
          html += `<table class="agents-table"><thead><tr><th>ID</th><th>Status</th><th>Started</th><th>Cost</th></tr></thead><tbody>`;
          for (const sa of subAgents) {
            const statusClass =
              sa.status === "active" || sa.status === "running"
                ? "badge-active"
                : sa.status === "idle"
                  ? "badge-idle"
                  : sa.status === "error"
                    ? "badge-error"
                    : "badge-ok";
            html += `<tr>
              <td><span class="job-id">${esc(sa.id)}</span></td>
              <td><span class="badge ${statusClass}">${esc(sa.status || "unknown")}</span></td>
              <td>${formatRelative(sa.started_at || sa.startedAt)}</td>
              <td>${sa.cost != null || sa.costUsd != null ? "$" + (sa.cost ?? sa.costUsd).toFixed(4) : "-"}</td>
            </tr>`;
          }
          html += "</tbody></table>";
        }

        container.innerHTML = html;
      }

      // -- Pipeline Health --
      async function loadPipelineHealth() {
        if (!token) return;
        const container = document.getElementById("pipelineContainer");
        container.innerHTML = '<div class="loading">Loading pipeline health</div>';

        try {
          const data = await apiFetch("/api/pipeline-health");
          renderPipelineHealth(data.pipelines || []);
        } catch (e) {
          if (e.message.includes("404") || e.message.includes("Not Found")) {
            container.innerHTML = `
            <div class="empty-state">
              <div class="icon">&gt;_</div>
              <div>Pipeline health endpoint not available yet</div>
              <div style="margin-top: 8px; font-size: 11px; color: var(--text-muted)">
                GET /api/pipeline-health returned 404. This feature will be available once the endpoint is implemented.
              </div>
            </div>`;
          } else {
            container.innerHTML = `<div class="empty-state"><div>Failed to load: ${esc(e.message)}</div></div>`;
          }
        }
      }

      function renderPipelineHealth(pipelines) {
        const container = document.getElementById("pipelineContainer");

        if (pipelines.length === 0) {
          container.innerHTML = `
          <div class="empty-state">
            <div class="icon">&gt;_</div>
            <div>No pipeline data available</div>
          </div>`;
          return;
        }

        let html = '<div class="pipeline-cards">';

        for (const p of pipelines) {
          const statusClass =
            p.status === "healthy"
              ? "badge-ok"
              : p.status === "degraded"
                ? "badge-running"
                : p.status === "down"
                  ? "badge-error"
                  : "badge-never";

          html += `
          <div class="pipeline-card">
            <div class="pipeline-card-header">
              <span class="pipeline-card-title">${esc(p.name || p.id)}</span>
              <span class="badge ${statusClass}">${esc(p.status || "unknown")}</span>
            </div>
            <div class="pipeline-stat-grid">
              <div class="pipeline-stat">
                <div class="pipeline-stat-label">Inventory</div>
                <div class="pipeline-stat-value">${formatNumber(p.inventory)}</div>
              </div>
              <div class="pipeline-stat">
                <div class="pipeline-stat-label">24h Applied</div>
                <div class="pipeline-stat-value">${formatNumber(p.applied24h)}</div>
              </div>
              <div class="pipeline-stat">
                <div class="pipeline-stat-label">24h Failed</div>
                <div class="pipeline-stat-value">${formatNumber(p.failed24h)}</div>
              </div>
              <div class="pipeline-stat">
                <div class="pipeline-stat-label">Success Rate</div>
                <div class="pipeline-stat-value">${p.successRate != null ? p.successRate.toFixed(1) + "%" : "-"}</div>
              </div>
            </div>`;

          if (p.blockers && p.blockers.length > 0) {
            html += `<div class="pipeline-blockers">
              <div class="pipeline-blockers-label">Blockers</div>`;
            for (const b of p.blockers) {
              html += `<div class="pipeline-blocker-item">- ${esc(b)}</div>`;
            }
            html += "</div>";
          }

          html += "</div>";
        }

        html += "</div>";
        container.innerHTML = html;
      }

      // -- Tasks --
      let tasks = [];

      async function loadTasks() {
        if (!token) return;
        const container = document.getElementById("tasksContainer");
        container.innerHTML = '<div class="loading">Loading tasks</div>';

        try {
          const data = await apiFetch("/api/tasks");
          tasks = data.tasks || [];
          renderTasks();
        } catch (e) {
          container.innerHTML = `<div class="empty-state"><div>Failed to load tasks: ${esc(e.message)}</div></div>`;
        }
      }

      function renderTasks() {
        const container = document.getElementById("tasksContainer");
        const filterVal = document.getElementById("taskStatusFilter")?.value || "";
        const filtered = filterVal ? tasks.filter((t) => t.status === filterVal) : tasks;
        document.getElementById("taskCount").textContent = filtered.length;

        if (filtered.length === 0) {
          container.innerHTML = `
          <div class="empty-state">
            <div class="icon">&gt;_</div>
            <div>${filterVal ? "No " + filterVal.replace("_", " ") + " tasks" : "No tasks. Create one to get started."}</div>
          </div>`;
          return;
        }

        let html = `
        <table class="jobs-table">
          <thead>
            <tr>
              <th>Task</th>
              <th>Status</th>
              <th>Agent</th>
              <th class="hide-mobile">Priority</th>
              <th class="hide-mobile">Updated</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
        `;

        for (const task of filtered) {
          const statusClass =
            task.status === "completed"
              ? "badge-ok"
              : task.status === "in_progress"
                ? "badge-running"
                : task.status === "ready"
                  ? "badge-active"
                  : task.status === "failed"
                    ? "badge-error"
                    : "badge-never";

          const recurringInfo = task.recurring
            ? `<span class="badge badge-idle" style="font-size:9px">recurring${task.recurrence_schedule ? ": " + esc(task.recurrence_schedule) : ""}</span>`
            : "";

          let taskTags = [];
          try {
            taskTags = task.tags ? JSON.parse(task.tags) : [];
          } catch {
            taskTags = [];
          }
          const tagsHtml =
            taskTags.length > 0
              ? `<div style="margin-top:2px">${taskTags.map((t) => `<span style="font-size:9px;color:var(--text-muted);background:var(--bg);border:1px solid var(--border);border-radius:3px;padding:0 4px;margin-right:3px">${esc(t)}</span>`).join("")}</div>`
              : "";

          html += `
          <tr style="cursor:pointer" onclick="openEditTaskModal(${task.id})">
            <td>
              <div class="job-id">${esc(task.title)}</div>
              ${task.description ? `<div class="job-label">${esc(task.description.slice(0, 80))}${task.description.length > 80 ? "..." : ""}</div>` : ""}
              ${recurringInfo}
              ${tagsHtml}
            </td>
            <td><span class="badge ${statusClass}">${esc(task.status)}</span></td>
            <td>${esc(task.assigned_agent || "-")}</td>
            <td class="hide-mobile">${task.priority ?? "-"}</td>
            <td class="hide-mobile">${formatRelative(task.updated_at)}</td>
            <td>
              <div class="action-group">
                <button class="action-btn" onclick="event.stopPropagation(); openEditTaskModal(${task.id})" title="Edit">Edit</button>
                ${task.status === "ready" ? `<button class="run-now-btn" onclick="event.stopPropagation(); claimTask(${task.id})">Claim</button>` : ""}
                ${task.status === "in_progress" ? `<button class="run-now-btn" onclick="event.stopPropagation(); completeTask(${task.id})">Done</button>` : ""}
                <button class="action-btn delete" onclick="event.stopPropagation(); confirmDeleteTask(${task.id})" title="Delete">Del</button>
              </div>
            </td>
          </tr>
          `;
        }

        html += "</tbody></table>";

        // Show result of last completed task if available
        const completed = tasks.filter((t) => t.status === "completed" && t.result);
        if (completed.length > 0) {
          const last = completed[completed.length - 1];
          html += `
          <div style="margin-top: 16px; padding: 12px; background: var(--bg-card); border: 1px solid var(--border); border-radius: 6px;">
            <div style="font-size: 11px; color: var(--text-muted); margin-bottom: 4px;">Last completed: ${esc(last.title)}</div>
            <div class="result-preview">${esc(last.result?.slice(0, 200) || "")}</div>
          </div>`;
        }

        container.innerHTML = html;
      }

      function openCreateTaskModal() {
        document.getElementById("taskModalMode").value = "create";
        document.getElementById("taskModalTitle").textContent = "Create Task";
        document.getElementById("taskModalSave").textContent = "Create";
        document.getElementById("taskFormTitle").value = "";
        document.getElementById("taskFormDescription").value = "";
        document.getElementById("taskFormAgent").value = "";
        document.getElementById("taskFormPriority").value = "5";
        document.getElementById("taskFormRecurring").checked = false;
        document.getElementById("taskFormRecurrenceSchedule").value = "";
        document.getElementById("taskFormTags").value = "";
        document.getElementById("taskFormStatus").value = "ready";
        document.getElementById("taskFormId").value = "";
        document.getElementById("taskModal").classList.add("visible");

        // Populate agent dropdown from loaded jobs
        populateAgentDropdown();
      }

      function openEditTaskModal(taskId) {
        const task = tasks.find((t) => t.id === taskId);
        if (!task) return;

        document.getElementById("taskModalMode").value = "edit";
        document.getElementById("taskModalTitle").textContent = `Edit Task #${task.id}`;
        document.getElementById("taskModalSave").textContent = "Save";
        document.getElementById("taskFormTitle").value = task.title;
        document.getElementById("taskFormDescription").value = task.description || "";
        document.getElementById("taskFormAgent").value = task.assigned_agent || "";
        document.getElementById("taskFormPriority").value = task.priority ?? 5;
        document.getElementById("taskFormRecurring").checked = !!task.recurring;
        document.getElementById("taskFormRecurrenceSchedule").value =
          task.recurrence_schedule || "";
        let parsedTags = [];
        try {
          parsedTags = task.tags ? JSON.parse(task.tags) : [];
        } catch {
          parsedTags = [];
        }
        document.getElementById("taskFormTags").value = parsedTags.join(", ");
        document.getElementById("taskFormStatus").value = task.status || "ready";
        document.getElementById("taskFormId").value = task.id;
        document.getElementById("taskModal").classList.add("visible");

        populateAgentDropdown();
      }

      function populateAgentDropdown() {
        const select = document.getElementById("taskFormAgent");
        const current = select.value;
        // Keep first option (unassigned)
        select.innerHTML = '<option value="">Unassigned</option>';
        for (const job of jobs) {
          const opt = document.createElement("option");
          opt.value = job.id;
          opt.textContent = job.label || job.id;
          select.appendChild(opt);
        }
        select.value = current;
      }

      function closeTaskModal() {
        document.getElementById("taskModal").classList.remove("visible");
      }

      async function saveTask() {
        const mode = document.getElementById("taskModalMode").value;
        const title = document.getElementById("taskFormTitle").value.trim();
        if (!title) {
          toast("Title is required", "error");
          return;
        }

        const tagsRaw = document.getElementById("taskFormTags").value.trim();
        const tags = tagsRaw
          ? tagsRaw
              .split(",")
              .map((t) => t.trim())
              .filter(Boolean)
          : undefined;

        const payload = {
          title,
          description: document.getElementById("taskFormDescription").value.trim() || undefined,
          assigned_agent: document.getElementById("taskFormAgent").value || undefined,
          priority: parseInt(document.getElementById("taskFormPriority").value) || 5,
          recurring: document.getElementById("taskFormRecurring").checked,
          recurrence_schedule:
            document.getElementById("taskFormRecurrenceSchedule").value.trim() || undefined,
          tags: tags,
        };

        if (mode === "edit") {
          payload.status = document.getElementById("taskFormStatus").value;
        }

        const saveBtn = document.getElementById("taskModalSave");
        saveBtn.disabled = true;
        saveBtn.textContent = "Saving...";

        try {
          if (mode === "create") {
            await apiFetch("/api/tasks", { method: "POST", body: JSON.stringify(payload) });
            toast("Task created", "success");
          } else {
            const id = document.getElementById("taskFormId").value;
            await apiFetch(`/api/tasks/${id}`, { method: "PUT", body: JSON.stringify(payload) });
            toast("Task updated", "success");
          }
          closeTaskModal();
          await loadTasks();
        } catch (e) {
          toast(`Failed to save task: ${e.message}`, "error");
        } finally {
          saveBtn.disabled = false;
          saveBtn.textContent = mode === "create" ? "Create" : "Save";
        }
      }

      async function completeTask(taskId) {
        const task = tasks.find((t) => t.id === taskId);
        document.getElementById("confirmMessage").innerHTML =
          `Complete task "<strong>${esc(task?.title || taskId)}</strong>"?`;
        document.getElementById("confirmAction").textContent = "Complete";
        document.getElementById("confirmAction").className = "btn-save";
        pendingConfirmCallback = async () => {
          closeConfirm();
          try {
            await apiFetch(`/api/tasks/${taskId}/complete`, {
              method: "POST",
              body: JSON.stringify({ result: "Completed via dashboard" }),
            });
            toast("Task completed", "success");
            await loadTasks();
          } catch (e) {
            toast(`Failed to complete task: ${e.message}`, "error");
          }
          // Reset confirm button style
          document.getElementById("confirmAction").textContent = "Delete";
          document.getElementById("confirmAction").className = "btn-danger";
        };
        document.getElementById("confirmDialog").classList.add("visible");
      }

      async function claimTask(taskId) {
        try {
          await apiFetch(`/api/tasks/${taskId}/claim`, {
            method: "POST",
            body: JSON.stringify({ agent: "dashboard-user" }),
          });
          toast("Task claimed", "success");
          await loadTasks();
        } catch (e) {
          toast(`Failed to claim task: ${e.message}`, "error");
        }
      }

      function confirmDeleteTask(taskId) {
        const task = tasks.find((t) => t.id === taskId);
        document.getElementById("confirmMessage").textContent =
          `Delete task "${task?.title || taskId}"? This cannot be undone.`;
        pendingConfirmCallback = async () => {
          closeConfirm();
          try {
            await apiFetch(`/api/tasks/${taskId}`, { method: "DELETE" });
            toast("Task deleted", "success");
            await loadTasks();
          } catch (e) {
            toast(`Failed to delete task: ${e.message}`, "error");
          }
        };
        document.getElementById("confirmDialog").classList.add("visible");
      }

      // -- Auto-refresh --
      function startAutoRefresh() {
        if (refreshTimer) clearInterval(refreshTimer);
        refreshTimer = setInterval(() => {
          loadJobs();
          // Also refresh run history if a job is selected
          if (selectedJobId) {
            apiFetch(`/api/cron/jobs/${encodeURIComponent(selectedJobId)}/runs`)
              .then((data) => renderRuns(data.runs || []))
              .catch(() => {});
          }
          // Refresh current tab
          if (activeTab === "tasks") loadTasks();
          if (activeTab === "agents") loadAgents();
        }, 30000);
      }

      // -- Status --
      function setStatus(text, ok) {
        document.getElementById("statusDot").className = "status-dot" + (ok ? "" : " error");
        document.getElementById("statusText").textContent = text;
      }

      // -- Toast --
      function toast(msg, type = "info") {
        const container = document.getElementById("toastContainer");
        const el = document.createElement("div");
        el.className = `toast ${type}`;
        el.textContent = msg;
        container.appendChild(el);
        setTimeout(() => {
          el.style.opacity = "0";
          el.style.transition = "opacity 0.3s";
          setTimeout(() => el.remove(), 300);
        }, 4000);
      }

      // -- Formatting helpers --
      function formatRelative(isoStr) {
        if (!isoStr) return '<span style="color: var(--text-muted)">-</span>';
        try {
          const d = new Date(isoStr);
          const now = Date.now();
          const diff = now - d.getTime();

          if (diff < 0) {
            const absDiff = Math.abs(diff);
            if (absDiff < 60000) return `in ${Math.floor(absDiff / 1000)}s`;
            if (absDiff < 3600000) return `in ${Math.floor(absDiff / 60000)}m`;
            if (absDiff < 86400000)
              return `in ${Math.floor(absDiff / 3600000)}h ${Math.floor((absDiff % 3600000) / 60000)}m`;
            return `in ${Math.floor(absDiff / 86400000)}d`;
          }

          if (diff < 60000) return `${Math.floor(diff / 1000)}s ago`;
          if (diff < 3600000) return `${Math.floor(diff / 60000)}m ago`;
          if (diff < 86400000)
            return `${Math.floor(diff / 3600000)}h ${Math.floor((diff % 3600000) / 60000)}m ago`;
          return `${Math.floor(diff / 86400000)}d ago`;
        } catch {
          return esc(isoStr);
        }
      }

      function formatTimestamp(isoStr) {
        if (!isoStr) return "-";
        try {
          const d = new Date(isoStr);
          return d.toLocaleString(undefined, {
            month: "short",
            day: "numeric",
            hour: "2-digit",
            minute: "2-digit",
            second: "2-digit",
            hour12: false,
          });
        } catch {
          return esc(isoStr);
        }
      }

      function formatDuration(ms) {
        if (ms == null) return "-";
        if (ms < 1000) return `${ms}ms`;
        if (ms < 60000) return `${(ms / 1000).toFixed(1)}s`;
        const mins = Math.floor(ms / 60000);
        const secs = Math.floor((ms % 60000) / 1000);
        return `${mins}m ${secs}s`;
      }

      function formatNumber(n) {
        if (n == null) return "-";
        return n.toLocaleString();
      }

      function esc(str) {
        if (!str) return "";
        const div = document.createElement("div");
        div.textContent = String(str);
        return div.innerHTML;
      }

      // Close modals on overlay click
      document.getElementById("jobModal").addEventListener("click", (e) => {
        if (e.target === e.currentTarget) closeJobModal();
      });
      document.getElementById("taskModal").addEventListener("click", (e) => {
        if (e.target === e.currentTarget) closeTaskModal();
      });
      document.getElementById("confirmDialog").addEventListener("click", (e) => {
        if (e.target === e.currentTarget) closeConfirm();
      });

      // Close modals on Escape key
      document.addEventListener("keydown", (e) => {
        if (e.key === "Escape") {
          if (document.getElementById("confirmDialog").classList.contains("visible")) {
            closeConfirm();
          } else if (document.getElementById("taskModal").classList.contains("visible")) {
            closeTaskModal();
          } else if (document.getElementById("jobModal").classList.contains("visible")) {
            closeJobModal();
          }
        }
      });
    </script>
  </body>
</html>
